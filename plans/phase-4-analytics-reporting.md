# Phase 4: Analytics & Reporting

**Timeline:** Day 6

## Overview

This phase enhances the reporting and analytics capabilities of HappyTube. We'll create beautiful HTML templates, implement analytics queries, and add data export functionality for long-term analysis.

## Goals

- Create polished HTML report templates
- Implement analytics queries using pandas
- Add Parquet export for time-series analysis
- Create base template for consistent styling
- Add template filters and helpers
- Enable trend analysis over time
- Test full pipeline end-to-end

## Tasks

### 1. Create Base HTML Template

**File:** `templates/base.html`

**Purpose:** Base template with common styling and structure.

**Implementation:**
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HappyTube Report{% endblock %}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        {% block extra_styles %}{% endblock %}
    </style>
</head>
<body>
    <div class="container">
        {% block header %}
        <div class="header">
            <h1>üé• HappyTube</h1>
            <div class="subtitle">YouTube Happiness Analyzer</div>
        </div>
        {% endblock %}

        <div class="content">
            {% block content %}{% endblock %}
        </div>

        <div class="footer">
            {% block footer %}
            Generated by HappyTube on {{ now }}
            {% endblock %}
        </div>
    </div>
</body>
</html>
```

### 2. Create Daily Report Template

**File:** `templates/daily_report.html`

**Purpose:** Daily report showing enhanced videos with happiness scores.

**Implementation:**
```html
{% extends "base.html" %}

{% block title %}HappyTube Report - {{ date }}{% endblock %}

{% block extra_styles %}
<style>
    .video-grid {
        display: grid;
        gap: 20px;
        margin-top: 20px;
    }

    .video-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 25px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .video-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .video-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .video-title {
        font-size: 1.4em;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
        flex: 1;
    }

    .happiness-badge {
        display: inline-block;
        font-weight: 700;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        white-space: nowrap;
        margin-left: 15px;
    }

    .happiness-5 { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .happiness-4 { background: linear-gradient(135deg, #5cb85c 0%, #7ed957 100%); }
    .happiness-3 { background: linear-gradient(135deg, #f0ad4e 0%, #ffc107 100%); }
    .happiness-2 { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); }
    .happiness-1 { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

    .video-meta {
        display: flex;
        gap: 20px;
        color: #666;
        font-size: 0.9em;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .video-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .video-meta .icon {
        font-size: 1.1em;
    }

    .reasoning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px;
        margin: 15px 0;
        border-radius: 4px;
        font-style: italic;
        color: #856404;
    }

    .description-section {
        margin-top: 15px;
    }

    .description-section h3 {
        font-size: 1.1em;
        color: #495057;
        margin-bottom: 10px;
    }

    .description-text {
        line-height: 1.8;
        color: #555;
        padding: 15px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .watch-button {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        text-decoration: none;
        margin-top: 15px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .watch-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .section-title {
        font-size: 1.8em;
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
    }
</style>
{% endblock %}

{% block header %}
<div class="header">
    <h1>üé• HappyTube Daily Report</h1>
    <div class="subtitle">{{ date }}</div>

    <div class="stats">
        <div class="stat-card">
            <span class="value">{{ total_count }}</span>
            <span class="label">Videos Enhanced</span>
        </div>
        <div class="stat-card">
            <span class="value">{{ "%.1f"|format(avg_happiness) }}</span>
            <span class="label">Avg Happiness</span>
        </div>
        <div class="stat-card">
            <span class="value">{{ videos|selectattr('happiness_score', 'eq', 5)|list|length }}</span>
            <span class="label">Very Happy (5/5)</span>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<h2 class="section-title">Enhanced Happy Videos</h2>

{% if videos %}
<div class="video-grid">
    {% for video in videos %}
    <div class="video-card">
        <div class="video-header">
            <h3 class="video-title">{{ video.title }}</h3>
            <span class="happiness-badge happiness-{{ video.happiness_score }}">
                ‚≠ê {{ video.happiness_score }}/5
            </span>
        </div>

        <div class="video-meta">
            <span>
                <span class="icon">üì∫</span>
                {{ video.channel }}
            </span>
            {% if video.category %}
            <span>
                <span class="icon">üè∑Ô∏è</span>
                {{ video.category }}
            </span>
            {% endif %}
            {% if video.duration %}
            <span>
                <span class="icon">‚è±Ô∏è</span>
                {{ (video.duration // 60)|int }}:{{ "%02d"|format(video.duration % 60) }}
            </span>
            {% endif %}
        </div>

        {% if video.happiness_reasoning %}
        <div class="reasoning">
            <strong>Why it's happy:</strong> {{ video.happiness_reasoning }}
        </div>
        {% endif %}

        {% if video.enhanced_description %}
        <div class="description-section">
            <h3>‚ú® Enhanced Description</h3>
            <div class="description-text">
                {{ video.enhanced_description }}
            </div>
        </div>
        {% endif %}

        <a href="https://youtube.com/watch?v={{ video.video_id }}"
           class="watch-button"
           target="_blank">
            ‚ñ∂Ô∏è Watch Video
        </a>
    </div>
    {% endfor %}
</div>
{% else %}
<p style="text-align: center; color: #999; padding: 40px;">
    No videos found for this date.
</p>
{% endif %}
{% endblock %}

{% block footer %}
{{ super() }} | Generated at {{ now }}
{% endblock %}
```

### 3. Update ReportStage with Template Context

**File:** `happytube/stages/report.py` (update)

Add timestamp to template context:

```python
from datetime import datetime

# In the run method, update template rendering:
html = template.render(
    date=target_date.strftime("%Y-%m-%d"),
    videos=videos,
    total_count=len(videos),
    avg_happiness=avg_happiness,
    now=datetime.now().strftime("%Y-%m-%d %H:%M:%S")
)
```

### 4. Add Analytics Module

**File:** `happytube/analytics/__init__.py`

```python
"""Analytics module for HappyTube."""
```

**File:** `happytube/analytics/queries.py`

**Purpose:** Common analytics queries using pandas and parquet files.

**Implementation:**
```python
import pandas as pd
from pathlib import Path
from datetime import date, timedelta
from typing import Optional

def load_parquet_data(stage: str, days_back: int = 7) -> pd.DataFrame:
    """Load parquet data for a stage."""
    parquet_dir = Path("parquet") / stage / "by-run-date"

    if not parquet_dir.exists():
        return pd.DataFrame()

    # Find most recent parquet file
    parquet_files = list(parquet_dir.glob("*.parquet"))
    if not parquet_files:
        return pd.DataFrame()

    # Load most recent
    latest_file = max(parquet_files, key=lambda p: p.stat().st_mtime)
    return pd.read_parquet(latest_file)


def happiness_distribution(df: pd.DataFrame) -> pd.Series:
    """Get distribution of happiness scores."""
    if df.empty or 'happiness_score' not in df.columns:
        return pd.Series(dtype=int)

    return df['happiness_score'].value_counts().sort_index()


def top_channels_by_happiness(df: pd.DataFrame, top_n: int = 10) -> pd.DataFrame:
    """Get top channels by average happiness score."""
    if df.empty or 'happiness_score' not in df.columns:
        return pd.DataFrame()

    return (
        df.groupby('channel')
        .agg({
            'happiness_score': ['mean', 'count']
        })
        .sort_values(('happiness_score', 'mean'), ascending=False)
        .head(top_n)
    )


def happiness_over_time(df: pd.DataFrame) -> pd.DataFrame:
    """Calculate average happiness per day."""
    if df.empty or 'happiness_score' not in df.columns:
        return pd.DataFrame()

    df['date'] = pd.to_datetime(df['fetched_at']).dt.date

    return (
        df.groupby('date')
        .agg({
            'happiness_score': ['mean', 'count'],
            'video_id': 'count'
        })
        .reset_index()
    )


def category_analysis(df: pd.DataFrame) -> pd.DataFrame:
    """Analyze happiness by category."""
    if df.empty or 'category' not in df.columns:
        return pd.DataFrame()

    return (
        df.groupby('category')
        .agg({
            'happiness_score': ['mean', 'std', 'count'],
            'video_id': 'count'
        })
        .sort_values(('happiness_score', 'mean'), ascending=False)
    )


def export_summary_stats(output_path: Path, days_back: int = 30) -> None:
    """Export summary statistics to CSV."""
    # Load all data
    assess_df = load_parquet_data('assess', days_back)

    if assess_df.empty:
        print("No data to export")
        return

    # Calculate various statistics
    stats = {
        'total_videos': len(assess_df),
        'avg_happiness': assess_df['happiness_score'].mean(),
        'median_happiness': assess_df['happiness_score'].median(),
        'std_happiness': assess_df['happiness_score'].std(),
        'videos_happy_3_plus': len(assess_df[assess_df['happiness_score'] >= 3]),
        'videos_very_happy_5': len(assess_df[assess_df['happiness_score'] == 5]),
        'unique_channels': assess_df['channel'].nunique(),
        'unique_categories': assess_df['category'].nunique(),
    }

    # Convert to DataFrame and save
    stats_df = pd.DataFrame([stats])
    output_path.parent.mkdir(parents=True, exist_ok=True)
    stats_df.to_csv(output_path, index=False)

    print(f"Summary stats exported to {output_path}")
```

### 5. Add Analytics CLI Command

**File:** `happytube/cli/commands.py` (add new command)

```python
@app.command()
def analytics(
    days_back: int = typer.Option(
        7,
        "--days",
        "-d",
        help="Number of days to analyze"
    ),
    export: bool = typer.Option(
        False,
        "--export",
        "-e",
        help="Export summary to CSV"
    )
):
    """
    Show analytics and statistics.

    Example:
        happytube analytics --days 30
        happytube analytics --days 7 --export
    """
    from rich.table import Table
    from happytube.analytics.queries import (
        load_parquet_data,
        happiness_distribution,
        top_channels_by_happiness,
        export_summary_stats
    )

    console.print(f"\n[bold]Analytics for last {days_back} days[/bold]\n")

    # Load data
    df = load_parquet_data('assess', days_back)

    if df.empty:
        console.print("[yellow]No data available for analysis[/yellow]")
        raise typer.Exit(code=0)

    # Overall stats
    avg_happiness = df['happiness_score'].mean()
    total_videos = len(df)
    happy_videos = len(df[df['happiness_score'] >= 3])

    stats_table = Table(title="Overall Statistics", show_header=True)
    stats_table.add_column("Metric", style="cyan")
    stats_table.add_column("Value", style="green")

    stats_table.add_row("Total Videos", str(total_videos))
    stats_table.add_row("Avg Happiness", f"{avg_happiness:.2f}/5")
    stats_table.add_row("Happy Videos (‚â•3)", f"{happy_videos} ({happy_videos/total_videos*100:.1f}%)")

    console.print(stats_table)
    console.print()

    # Happiness distribution
    dist = happiness_distribution(df)
    dist_table = Table(title="Happiness Distribution", show_header=True)
    dist_table.add_column("Score", justify="center", style="cyan")
    dist_table.add_column("Count", justify="right", style="green")
    dist_table.add_column("Percentage", justify="right", style="yellow")

    for score, count in dist.items():
        percentage = (count / total_videos) * 100
        dist_table.add_row(
            f"‚≠ê {score}/5",
            str(count),
            f"{percentage:.1f}%"
        )

    console.print(dist_table)
    console.print()

    # Top channels
    top_channels = top_channels_by_happiness(df, top_n=10)
    if not top_channels.empty:
        channels_table = Table(title="Top 10 Channels by Happiness", show_header=True)
        channels_table.add_column("Channel", style="cyan")
        channels_table.add_column("Avg Score", justify="right", style="green")
        channels_table.add_column("Videos", justify="right", style="yellow")

        for channel, row in top_channels.iterrows():
            channels_table.add_row(
                channel,
                f"{row[('happiness_score', 'mean')]:.2f}",
                str(int(row[('happiness_score', 'count')]))
            )

        console.print(channels_table)
        console.print()

    # Export if requested
    if export:
        output_path = Path("analytics") / f"summary_{date.today()}.csv"
        export_summary_stats(output_path, days_back)
        console.print(f"[green]‚úì Summary exported to {output_path}[/green]")
```

### 6. End-to-End Pipeline Test

Create a test script to validate the entire pipeline:

**File:** `tests/test_pipeline.py`

```python
import pytest
import asyncio
from datetime import date
from pathlib import Path

from happytube.stages.fetch import FetchStage
from happytube.stages.assess import AssessStage
from happytube.stages.enhance import EnhanceStage
from happytube.stages.report import ReportStage
from happytube.config.config_manager import ConfigManager


@pytest.mark.asyncio
async def test_full_pipeline():
    """Test the complete pipeline end-to-end."""
    test_date = date.today()
    cm = ConfigManager()

    # Load configs
    youtube_config = cm.load_base_config('youtube')['searches']['music_search']['params']
    prompts_config = cm.load_base_config('prompts')

    # Stage 1: Fetch (limited to 3 for testing)
    fetch_stage = FetchStage(youtube_config, max_videos=3)
    fetch_result = await fetch_stage.run(test_date)
    assert fetch_result['status'] == 'success'
    assert fetch_result['new_videos'] > 0

    # Stage 2: Assess
    assess_stage = AssessStage(prompts_config['prompts']['happiness_v2'])
    assess_result = await assess_stage.run(test_date)
    assert assess_result['status'] == 'success'
    assert assess_result['assessed_videos'] > 0

    # Stage 3: Enhance
    enhance_stage = EnhanceStage(prompts_config['prompts']['enhance_description_v1'], threshold=1)
    enhance_result = await enhance_stage.run(test_date)
    assert enhance_result['status'] in ['success', 'no_videos_to_enhance']

    # Stage 4: Report
    report_stage = ReportStage()
    report_result = await report_stage.run(test_date)
    assert report_result['status'] in ['success', 'no_videos_to_report']

    # Verify report file exists if videos were enhanced
    if enhance_result.get('enhanced_videos', 0) > 0:
        report_path = Path(report_result['report_path'])
        assert report_path.exists()
        assert report_path.stat().st_size > 0
```

## Testing Phase 4

```bash
# Test HTML template rendering
happytube run-all --max-videos 5
open stages/report/$(date +%Y-%m-%d).html

# Test analytics
happytube analytics --days 7
happytube analytics --days 30 --export

# Run end-to-end test
poetry run pytest tests/test_pipeline.py -v

# Check parquet exports
ls -lh parquet/*/by-run-date/
```

## Dependencies Summary

No new dependencies needed - all tools from previous phases.

## Success Criteria

- ‚úÖ HTML reports are beautiful and responsive
- ‚úÖ Base template provides consistent styling
- ‚úÖ Daily reports show all video information
- ‚úÖ Analytics queries work correctly
- ‚úÖ Parquet exports are generated
- ‚úÖ Analytics command displays useful stats
- ‚úÖ CSV export works
- ‚úÖ Full pipeline test passes
- ‚úÖ Reports can be opened in browser

## Next Phase

Phase 5 will focus on automation, error handling improvements, comprehensive testing, and documentation updates to make the system production-ready.
